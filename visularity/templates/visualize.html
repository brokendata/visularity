{% extends "base.html" %}

{% block title %}Visualize - {{ super() }}{% endblock title %}

{% block extrahead %}
<script type="text/javascript" src="{{ url_for('static', filename='js/d3.v2.js') }}"></script>
<link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/pack.css') }}"/>
{% endblock extrahead %}

{% block body %}

<h1>Similarity Scores</h1>

{% if computed_matches %}
<table>
    <thead>
    <th>Query</th>
    <th>Score against index terms</th>
    </thead>
    <tbody>
    {% for query, sim_scores in computed_matches.iteritems() %}
    <tr>
        <td>{{ query }}</td>
        <td>
            <ol>
                {% for score, text in sim_scores %}
                <li>{{ score }} {{ text }}</li>
                {% endfor %}
            </ol>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>Nothing yet.</p>
{% endif %}

<h1>Similarity Visualization</h1>
<button id="refresh" name="Refresh" value="Refresh">Refresh</button>

<h2>Hierarchical cluster</h2>
<div id="chart-hcluster"></div>

<h2>Affinity Propagation cluster</h2>
<div id="chart-apcluster"></div>

<h2>Dendrogram</h2>
<div id="chart-dcluster"></div>

{% endblock body %}

{% block extrajs %}
<script src="{{ url_for('static', filename='js/hookbox.js') }}" type="text/javascript"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/pack.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/cluster.js') }}"></script>
<script type="text/javascript">
    function refresh() {
        visualize_flat("{{ url_for('cluster', type='hcluster') }}", "#chart-hcluster");
        visualize_flat("{{ url_for('cluster', type='apcluster') }}", "#chart-apcluster");
        visualize_dendro("{{ url_for('cluster', type='dcluster') }}", "#chart-dcluster");
    }

    $(document).ready(function () {
        $("#refresh").on("click", function (event) {
            event.preventDefault();
            refresh();
        });

//        hookbox.logging.get('net.protocols.rtjp').setLevel(hookbox.logging.DEBUG);
        conn = hookbox.connect('http://127.0.0.1:8001/');

        conn.onSubscribed = function (channel_name, subscription) {

            console.log("subscription.history was " + subscription.history);

            subscription.onPublish = function (frame) {
                console.log("frame.payload was " + frame.payload);
                refresh();
            };

        };

        // subscribe to the channel
        var hookboxChannel = '{{ hookbox_channel }}';
        conn.subscribe(hookboxChannel);
    });
</script>
{% endblock extrajs %}
